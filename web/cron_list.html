<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>任务列表</title>
    <link rel="stylesheet" href="/static/css/element-ui@2.15.9.css">
    <script src="/static/js/vue@2.7.8.js"></script>
    <script src="/static/js/element-ui@2.15.9.js"></script>
    <script src="/static/js/home.js"></script>
    <script src="/static/js/jquery.min.js"></script>
    <style>
        .icon{
            font-size: 24px;
        }
        .warning{
            color: #e6a23c;
        }
        .success{
            color: #67c23a;
        }
        .danger{
            color: #f56c6c;
        }
    </style>
</head>
<body>
    <div id="app">
        <el-container>
            <!-- <el-aside width="200px">边栏</el-aside> -->
            <el-container>
                <el-header>
                    <a href="https://cron.qqe2.com/" target="_blank">6位 时间格式生成器</a>
                </el-header>

                <el-main>
                    <el-button type="text" @click="createShow()">添加任务</el-button>
                    <el-button type="text" @click="registerList()">已注册任务</el-button>

                    <el-table :data="listData">
                        <el-table-column prop="id" label="编号"></el-table-column>
                        <el-table-column prop="" label="执行成功率">
                            <template slot-scope="scope">
                                <el-tooltip placement="top-start">
                                    <div slot="content">{{scope.row.topRatio}}%<br/>近期{{scope.row.top_number}}次执行，{{scope.row.top_error_number}}次失败。</div>
                                    <i :class="getTopIcon(scope.row.top_number, scope.row.topRatio)"></i>
                                </el-tooltip>
                            </template>
                        </el-table-column>
                        <el-table-column prop="spec" label="执行时间"></el-table-column>
                        <el-table-column prop="name" label="任务名称"></el-table-column>
                        <el-table-column prop="protocol_name" label="协议"></el-table-column>
                        <el-table-column prop="remark" label="备注"></el-table-column>
                        <el-table-column prop="status_name" label="状态">
                            <template slot-scope="scope">
                                <el-switch
                                        validate-event="true"
                                        :value="scope.row.status"
                                        active-value="2"
                                        inactive-value="1"
                                        @change="changeStatus(scope.$index, scope.row.id, $event)"
                                ></el-switch>
                            </template>
                        </el-table-column>
                        <el-table-column label="操作">
                            <template slot-scope="scope">
                                <el-button type="text" @click="editShow(scope.$index)">编辑</el-button>
                                <el-button type="text" @click="logByConfig(scope.row.id, scope.row.name)">日志</el-button>
                            </template>
<!--                            // 操作，再弹窗中进行操作（小型弹窗）；-->
<!--                            // 日志，侧边栏弹窗查看完整日志；-->
                        </el-table-column>
                    </el-table>
                    <el-pagination
                            @size-change="handleSizeChange"
                            @current-change="handleCurrentChange"
                            :current-page.sync="listPage.page"
                            :page-size="listPage.size"
                            layout="total, prev, pager, next"
                            :total="listPage.total">
                    </el-pagination>
                </el-main>

                <!-- <el-footer>页脚</el-footer> -->
            </el-container>
        </el-container>

        <!-- 任务设置表单 -->
        <el-dialog :title="setConfigTitle" :visible.sync="setConfigShow" :close-on-click-modal="false">
            <el-form :model="form">
                <el-form-item label="活动名称*">
                    <el-input v-model="form.name"></el-input>
                </el-form-item>
                <el-form-item label="时间*">
                    <el-input v-model="form.spec"></el-input>
                </el-form-item>
                <el-form-item>
                    <el-tabs type="border-card" v-model="form.protocol">
                        <el-tab-pane label="http" name="1">
                            <el-form-item label="请求方式">
                                <el-select v-model="form.command.http.method" placeholder="请选请求方式">
                                    <el-option label="GET" value="GET"></el-option>
                                    <el-option label="POST" value="POST"></el-option>
                                </el-select>
                            </el-form-item>
                            <el-form-item label="请求url地址">
                                <el-input v-model="form.command.http.url" placeholder="请输入http:// 或 https:// 开头的完整地址"></el-input>
                            </el-form-item>
                            <el-form-item label="请求body参数">
                                <el-input type="textarea" v-model="form.command.http.body" rows="5" placeholder="POST请求时body参数，将通过json进行请求发起"></el-input>
                            </el-form-item>
                        </el-tab-pane>
                        <el-tab-pane label="rpc" name="2">
                            <el-form-item label="请求模式">
                                <el-select v-model="form.command.rpc.method" placeholder="请选请求方式">
                                    <el-option label="GRPC" value="GRPC"></el-option>
                                </el-select>
                            </el-form-item>
                            <el-form-item label="地址">
                                <el-input v-model="form.command.rpc.addr" placeholder="请输入服务地址，含端口; 示例：localhost:21014"></el-input>
                            </el-form-item>
                            <el-form-item label="方法">
                                <el-input v-model="form.command.rpc.action" placeholder="请输入服务方法; 示例：/merchantpush.Merchantpush/Echo"></el-input>
                            </el-form-item>
                            <el-form-item label="请求参数">
                                <el-input type="textarea" v-model="form.command.rpc.body" rows="5" placeholder="请输入请求参数"></el-input>
                            </el-form-item>
                        </el-tab-pane>
                        <el-tab-pane label="cmd" name="3">
                            <el-input type="textarea" v-model="form.command.cmd" rows="5" :placeholder="sysInfo.cmd_name + ': 请输入命令行执行内容'"></el-input>
                        </el-tab-pane>
                    </el-tabs>
                </el-form-item>
                <el-form-item label="备注">
                    <el-input v-model="form.remark"></el-input>
                </el-form-item>
            </el-form>
            <div slot="footer" class="dialog-footer">
                <el-button @click="setConfigShow = false">取 消</el-button>
                <el-button type="primary" @click="setCron()">确 定</el-button>
            </div>
        </el-dialog>
        <!-- 任务日志弹窗 -->
        <el-drawer :title="configLogTitle" :visible.sync="configLogShow" direction="rtl" size="40%" wrapperClosable="false">
            <el-table :data="logListData">
                <el-table-column property="create_dt" label="记录时间"></el-table-column>
                <el-table-column property="status_name" label="状态">
                    <template slot-scope="scope">
                        <el-tag :type="scope.row.status == 1 ? 'danger' : 'success'">{{scope.row.status_name}}</el-tag>
                    </template>
                </el-table-column>
                <el-table-column property="duration" label="耗时/秒"></el-table-column>
                <el-table-column property="" label="详情">
                    <template slot-scope="scope">
                        <el-popover trigger="hover" placement="left">
                            <div>{{scope.row.body}}</div>
                            <div slot="reference" class="name-wrapper">
                                <el-tag size="medium">详情</el-tag>
                            </div>
                        </el-popover>
                    </template>
                </el-table-column>
            </el-table>
        </el-drawer>
        <!-- 注册任务列表弹窗 -->
        <el-drawer title="已注册任务" :visible.sync="registerListShow" direction="rtl" size="40%" wrapperClosable="false">
            <el-table :data="registerListData">
                <el-table-column property="id" label="编号"></el-table-column>
                <el-table-column property="spec" label="执行时间"></el-table-column>
                <el-table-column property="update_dt" label="下一次执行"></el-table-column>
                <el-table-column property="name" label="任务名称"></el-table-column>
                <el-table-column property="" label="">
                    <template slot-scope="scope">
                        <el-button type="text" @click="logByConfig(scope.row.id, scope.row.name)">日志</el-button>
                    </template>
                </el-table-column>
            </el-table>
        </el-drawer>
    </div>


</body>
<script>
    new Vue({
        el: '#app',
        data(){
            return {
                listData: [],
                listPage:{
                    total:0,
                    page: 1,
                    size: 20,
                },
                logListData: [], // 日志列表，没有分页；
                configLogShow: false, // 任务日志弹窗
                configLogTitle: '',
                registerListData: [],
                registerListShow: false,
                setConfigShow: false, // 新增弹窗
                setConfigTitle: '',
                form:{command:{http:{method:''},rpc:{method:''}}},
                sysInfo: {cmd_name:""},
            };
        },
        created(){
            this.getList()
            api.innerGet("/system/info",{}, (res)=>{
                if (res.code != "000000"){
                    return this.$message.error(res.message);
                }
                this.sysInfo = res.data;
            })
        },
        methods:{
            // 任务列表
            getList(){
                api.innerGet("/config/list", {}, (res)=>{
                    console.log("列表响应",res)
                    if (res.code != "000000"){
                        return this.$message.error(res.message);
                    }
                    for (i in res.data.list){
                        let ratio = 0
                        if (res.data.list[i].top_number){
                            ratio = res.data.list[i].top_error_number / res.data.list[i].top_number
                        }


                        res.data.list[i].status = res.data.list[i].status.toString()
                        res.data.list[i].topRatio = 100 - ratio * 100
                    }
                    this.listData = res.data.list;
                    this.listPage = res.data.page;
                })
            },
            handleSizeChange(val) {
                console.log(`每页 ${val} 条`);
            },
            handleCurrentChange(val) {
                console.log(`当前页: ${val}`);
            },
            // 添加/编辑 任务
            setCron(){
                if (this.form.name == ''){
                    return this.$message.error('请输入任务名称')
                }else if (this.form.spec == ''){
                    return this.$message.error('请输入任务执行时间')
                }else if (!this.form.protocol){
                    return this.$message.error('请选择任务协议')
                }
                // else if (this.form.command == ''){
                //     return this.$message.error('请输入命令类容')
                // }

                // 主要是强制类型
                let body = {
                    id: this.form.id,
                    name: this.form.name,
                    spec: this.form.spec,
                    protocol: Number(this.form.protocol),
                    command: this.form.command,
                    remark: this.form.remark,
                }

                api.innerPost("/config/set", body, (res)=>{
                    if (res.code != '000000'){
                        return this.$message.error(res.message)
                    }
                    this.setConfigShow = false;
                    this.form = {command:{
                            http:{
                                method: '',
                                url:'',
                                body:''
                            },
                            rpc:{
                                method: 'GRPC',
                                addr: '',
                                action: '',
                                body: ''
                            },
                            cmd:''
                        }}; // 清空表达数据
                    this.getList(); // 刷新当前页
                })
            },
            // 添加弹窗
            createShow(){
                this.setConfigShow = true
                this.setConfigTitle = '添加任务'
                // 应该有个地方定义空结构体
                this.form = {
                    command:{
                        http:{
                            method: '',
                            url:'',
                            body:''
                        },
                        rpc:{
                            method: 'GRPC',
                            addr: '',
                            action: '',
                            body: ''
                        },
                        cmd:''
                    }
                }
            },
            // 编辑弹窗
            editShow(index){
                this.setConfigShow = true
                this.setConfigTitle = '编辑任务'
                this.form = this.listData[index]
                this.form.status = this.form.status.toString() // 这里要转字符串，否则可能显示数字
                this.form.protocol = this.form.protocol.toString()
                console.log(this.form)
            },
            // 改变状态
            changeStatus(index, id, newStatus){
                this.$confirm(newStatus=='1'? '确认关闭任务': '确认开启任务', '提示',{
                    type: 'warning',
                }).then(()=>{
                    // 确认操作
                    api.innerPost("/config/change_status", {id:id,status:Number(newStatus)}, (res)=>{
                        console.log("状态改变响应",res)
                        if (res.code != '000000'){
                            return this.$message.error(res.message)
                        }
                        this.listData[index].status = newStatus
                        return this.$message.success(res.message)
                    })
                }).catch(()=>{
                    // 取消操作
                })
            },
            // 配置日志
            logByConfig(id, title){
                this.configLogShow = true;
                this.configLogTitle = title+' 任务日志';
                api.innerGet("/log/by_config", {conf_id:id, limit:15}, (res)=>{
                    if (res.code != "000000"){
                        return this.$message.error(res.message);
                    }
                    this.logListData = res.data.list;
                })
            },
            registerList(){
                this.registerListShow = true;
                api.innerGet("/config/register_list", {}, (res)=>{
                    if (res.code != "000000"){
                        return this.$message.error(res.message);
                    }
                    this.registerListData = res.data.list;
                })
            },
            // 成功率图标
            getTopIcon(total, ratio){
                // 没有执行
                if (total == 0){
                    return "icon el-icon-remove-outline" // 0
                }
                // 成功率100
                if (ratio == 100){
                    return "icon el-icon-circle-check success"
                }
                // 成功率66以上
                if (ratio < 100 && ratio > 66){
                    return "icon el-icon-warning-outline warning"
                }
                // 成功率33以上
                if (ratio < 66 && ratio > 33){
                    return "icon el-icon-circle-plus-outline danger"
                }
                // 成功率33一下
                return "icon el-icon-circle-close danger"
            }
        }
    })
</script>
</html>